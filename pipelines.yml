resources:
  - name: jfrogCliGit
    type: GitRepo
    configuration:
      path: yahavi/jfrog-cli
      gitProvider: myGitHub

pipelines:
  # Global configuration
  - name: TestCLI
    configuration:
      runtime:
        type: image
        image:
          auto:
            language: go
            versions:
              - "1.13.7"

    steps:
      # Artifactory tests
      - name: Artifactory
        type: Bash
        configuration:
          integrations:
            - name: artifactory
          inputResources:
            - name: jfrogCliGit
        execution:
          onExecute:
            - cd $res_jfrogCliGit_resourcePath
            - go test -v github.com/jfrog/jfrog-cli --timeout 0 -test.artifactory -rt.url=$int_artifactory_url -rt.user=$int_artifactory_user -rt.password=$int_artifactory_apikey

      # Bintray tests
      - name: Bintray
        type: Bash
        configuration:
          integrations:
            - name: artifactory
            - name: bintray
          inputResources:
            - name: jfrogCliGit
        execution:
          onExecute:
            - cd $res_jfrogCliGit_resourcePath
            - go test -v github.com/jfrog/jfrog-cli --timeout 0 -test.bintray -rt.url=$int_artifactory_url -rt.user=$int_artifactory_user -rt.password=$int_artifactory_apikey --bt.user=$int_bintray_user -bt.key=$int_bintray_key

      # Npm tests
      - name: Npm
        type: Bash
        configuration:
          integrations:
            - name: artifactory
          inputResources:
            - name: jfrogCliGit
        execution:
          onExecute:
            - cd $res_jfrogCliGit_resourcePath
            - curl -sL https://deb.nodesource.com/setup_11.x | sudo bash -
            - sudo apt install nodejs
            - npm --version
            - go test -v github.com/jfrog/jfrog-cli --timeout 0 -test.npm -rt.url=$int_artifactory_url -rt.user=$int_artifactory_user -rt.password=$int_artifactory_apikey

      # Install Maven and Gradle
      - name: InstallJava
        type: Bash
        configuration:
          inputResources:
            - name: jfrogCliGit
          affinityGroup: java
        execution:
          onExecute:
            - sudo apt install zip
            - curl -s "https://get.sdkman.io" | bash
            - source "$HOME/.sdkman/bin/sdkman-init.sh"
            - sdk install java `sdk list java | grep -E "8.*-zulu" | head -1 | awk '{print $NF}'` && java -version
            - sdk use maven 3.3.9 || sdk install maven 3.3.9
            - sdk default gradle || sdk install gradle

      # Maven tests
      - name: Maven
        type: Bash
        configuration:
          integrations:
            - name: artifactory
          inputResources:
            - name: jfrogCliGit
          affinityGroup: java
          inputSteps:
            - name: InstallJava
        execution:
          onExecute:
            - cd $res_jfrogCliGit_resourcePath
            # - sudo apt install zip
            # - curl -s "https://get.sdkman.io" | bash
            # - source "$HOME/.sdkman/bin/sdkman-init.sh"
            # - sdk install java `sdk list java | grep -E "8.*-zulu" | head -1 | awk '{print $NF}'` && java -version
            # - sdk use maven 3.3.9 || sdk install maven 3.3.9
            - mvn --version
            - go test -v github.com/jfrog/jfrog-cli --timeout 0 -test.maven -rt.url=$int_artifactory_url -rt.user=$int_artifactory_user -rt.password=$int_artifactory_apikey

      # Gradle tests
      - name: Gradle
        type: Bash
        configuration:
          integrations:
            - name: artifactory
          inputResources:
            - name: jfrogCliGit
          affinityGroup: java
          inputSteps:
            - name: InstallJava
        execution:
          onExecute:
            - cd $res_jfrogCliGit_resourcePath
            # - sudo apt install zip
            # - curl -s "https://get.sdkman.io" | bash
            # - source "$HOME/.sdkman/bin/sdkman-init.sh"
            # - sdk install java `sdk list java | grep -E "8.*-zulu" | head -1 | awk '{print $NF}'` && java -version
            # - sdk default gradle || sdk install gradle
            - gradle --version
            - go test -v github.com/jfrog/jfrog-cli --timeout 0 -test.gradle -rt.url=$int_artifactory_url -rt.user=$int_artifactory_user -rt.password=$int_artifactory_apikey

      # Go tests
      - name: Go
        type: Bash
        configuration:
          integrations:
            - name: artifactory
          inputResources:
            - name: jfrogCliGit
        execution:
          onExecute:
            - go version
            - cd $res_jfrogCliGit_resourcePath
            - go test -v github.com/jfrog/jfrog-cli --timeout 0 -test.go -rt.url=$int_artifactory_url -rt.user=$int_artifactory_user -rt.password=$int_artifactory_apikey

      # Pip tests
      - name: Pip
        type: Bash
        configuration:
          integrations:
            - name: artifactory
          inputResources:
            - name: jfrogCliGit
        execution:
          onExecute:
            - pip --version
            - cd $res_jfrogCliGit_resourcePath
            - python -m virtualenv pip-venv
            - go test -v github.com/jfrog/jfrog-cli --timeout 0 -test.pip -rt.pipVirtualEnv=${res_jfrogCliGit_resourcePath}/pip-venv/Scripts -rt.url=$int_artifactory_url -rt.user=$int_artifactory_user -rt.password=$int_artifactory_apikey

      # Distribution tests
      - name: Distribution
        type: Bash
        configuration:
          integrations:
            - name: artifactory
            - name: distribution
          inputResources:
            - name: jfrogCliGit
        execution:
          onExecute:
            - cd $res_jfrogCliGit_resourcePath
            - go test -v github.com/jfrog/jfrog-cli --timeout 0 -test.distribution -rt.url=$int_artifactory_url -rt.user=$int_artifactory_user -rt.password=$int_artifactory_apikey -rt.distUrl=$int_distribution_url
